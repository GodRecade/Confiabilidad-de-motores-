<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>Confiabilidad de Motores</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <style>
Â  Â  body { font-family: 'Inter', sans-serif; }
Â  Â  #planoContainer { touch-action: none; cursor: grab; user-select: none; }
Â  Â  #planoContainer:active { cursor: grabbing; }
Â  Â  #transformWrapper { transform-origin: 0 0; transition: transform 0.1s linear; }
Â  Â  #planoImage, #motoresContainer { user-select: none; -webkit-user-drag: none; }
Â  Â  .motor-marker {
Â  Â  Â  position: absolute; width: 14px; height: 14px; border-radius: 50%;
Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  font-weight: bold; font-size: 7px; line-height: 1;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transform: translate(-50%, -50%); transition: all 0.2s ease;
Â  Â  Â  border: 1px solid white; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4); z-index: 10;
Â  Â  }
Â  Â  .motor-marker.completed { background-color: #10B981; color: white; }
Â  Â  .motor-marker.pending { background-color: #EF4444; color: white; }
Â  Â  .motor-marker.maintenance { background-color: #FBBF24; color: #422006; }
Â  Â  .motor-marker:hover, .motor-marker.selected {Â 
Â  Â  Â  Â  transform: translate(-50%, -50%) scale(1.6);Â 
Â  Â  Â  Â  z-index: 20; border-color: #3b82f6;
Â  Â  }
Â  Â  #planoContainer.placing-mode, #planoContainer.moving-mode { cursor: crosshair !important; }
Â  Â  .motor-list-item { cursor: pointer; transition: background-color 0.2s; }
Â  Â  .motor-list-item:hover, .motor-list-item.selected { background-color: #e2e8f0; }
Â  </style>
Â  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-100 min-h-screen">
Â  <header class="bg-gradient-to-r from-red-800 to-red-700 text-white shadow-lg sticky top-0 z-50">
Â  Â  <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 py-2 flex items-center justify-between">
Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="https://i.ibb.co/Lh1fbHTG/envases.jpg" alt="Logo Empresa" class="h-24 w-24 rounded-md object-cover">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <h1 class="text-xl md:text-2xl font-bold tracking-tight">Confiabilidad de Motores</h1>
Â  Â  Â  Â  Â  Â  <p class="hidden md:block text-sm font-light text-red-100">LÃ­neas de producciÃ³n (transportes)</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="bg-red-600 rounded-xl p-2 md:p-3 shadow-lg">
Â  Â  Â  Â  <label class="text-red-100 text-sm font-medium sr-only md:not-sr-only mr-2">LÃ­nea:</label>
Â  Â  Â  Â  <select id="lineaSelector" class="bg-red-500 text-white font-bold py-2 px-3 rounded-lg border border-red-400">
Â  Â  Â  Â  Â  <option value="LINEA1">LÃ­nea 1</option> <option value="LINEA2">LÃ­nea 2</option> <option value="LINEA3">LÃ­nea 3</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>
Â  Â  </div>
Â  </header>

Â  <main class="max-w-screen-2xl mx-auto p-4">
Â  Â  <div class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-6">
Â  Â  Â  <div class="lg:col-span-2 xl:col-span-3">
Â  Â  Â  Â  <div class="bg-white rounded-2xl shadow-lg p-3 mb-4 flex justify-between items-center">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-bold text-slate-800" id="lineaTitle"></h2>
Â  Â  Â  Â  Â  Â  <p class="text-slate-600 text-xs md:text-sm">Use el botÃ³n "Mover" para reubicar marcadores. Use zoom para mÃ¡s precisiÃ³n.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="zoomControls" class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â <span id="zoomLevel" class="text-sm font-semibold text-slate-600 w-16 text-center">100%</span>
Â  Â  Â  Â  Â  Â  Â <button id="zoomOut" class="font-bold bg-slate-200 hover:bg-slate-300 rounded-md p-2 w-8 h-8 flex items-center justify-center">-</button>
Â  Â  Â  Â  Â  Â  Â <button id="zoomIn" class="font-bold bg-slate-200 hover:bg-slate-300 rounded-md p-2 w-8 h-8 flex items-center justify-center">+</button>
Â  Â  Â  Â  Â  Â  Â <button id="zoomReset" class="font-bold bg-slate-200 hover:bg-slate-300 rounded-md p-2 w-8 h-8 flex items-center justify-center">âŒ‚</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
Â  Â  Â  Â  Â  <div id="planoContainer" class="relative h-[50vh] lg:h-[75vh] overflow-hidden bg-slate-100">
Â  Â  Â  Â  Â  Â  <div id="transformWrapper">
Â  Â  Â  Â  Â  Â  Â  <img id="planoImage" draggable="false" class="h-auto object-contain min-h-full" src="" alt="Plano de LÃ­nea" />
Â  Â  Â  Â  Â  Â  Â  <div id="motoresContainer" style="position:absolute; inset:0; pointer-events:none;"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="w-full lg:col-span-1 xl:col-span-1 flex flex-col gap-6">
Â  Â  Â  Â  <div class="bg-slate-50 rounded-2xl shadow-lg p-4 border">
Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-slate-800 text-lg mb-3">Control y EstadÃ­sticas</h3>
Â  Â  Â  Â  Â  Â  <button id="btnCargarDatos" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">ğŸ”„ Cargar / Refrescar Datos</button>
Â  Â  Â  Â  Â  Â  <div id="statusMsg" class="text-sm text-center text-slate-600 mt-2">Presione "Cargar" para empezar.</div>
Â  Â  Â  Â  Â  Â  <div id="connBadge" class="mt-3 flex items-center justify-center space-x-2 bg-gray-500 px-3 py-1 rounded-full shadow text-white text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-2 h-2 bg-white rounded-full"></div> <span>Desconectado</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="statsContainer" class="mt-4 pt-3 border-t space-y-2 text-sm"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="bg-slate-50 rounded-2xl shadow-lg p-4 border">
Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-slate-800 text-lg mb-2">ğŸ“‹ Lista de Motores</h3>
Â  Â  Â  Â  Â  Â  <input type="text" id="motorSearch" class="w-full border rounded-xl px-4 py-2 text-sm mb-3" placeholder="Buscar por ID o Zona...">
Â  Â  Â  Â  Â  Â  <div id="fullMotorList" class="max-h-60 overflow-y-auto pr-2 space-y-1"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="motorDetailsPanel" class="bg-white rounded-2xl shadow-lg p-4 border hidden">
Â  Â  Â  Â  Â  <h3 class="font-bold text-slate-800 text-lg mb-3">âš™ï¸ Detalles: <span id="motorIdTitle" class="text-blue-600"></span></h3>
Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  <div class="text-center bg-slate-100 rounded-lg p-2"><img id="motorImage" class="max-h-32 mx-auto rounded cursor-pointer" /></div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-slate-700 mb-1">Nombre de Zona:</label>
Â  Â  Â  Â  Â  Â  Â  <input type="text" id="motorNombreZona" class="w-full border rounded-xl px-3 py-2 text-sm bg-slate-50" readonly />
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-slate-700 mb-1">Estado:</label>
Â  Â  Â  Â  Â  Â  Â  <select id="motorEstado" class="w-full border rounded-xl px-3 py-2 text-sm"></select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-slate-700 mb-1">Observaciones:</label>
Â  Â  Â  Â  Â  Â  Â  <textarea id="motorObservaciones" rows="2" class="w-full border rounded-xl px-3 py-2 text-sm"></textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="btnGuardar" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">ğŸ’¾ Guardar Cambios</button>
Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnPlaceMotor" class="w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 text-sm hidden">Colocar Marcador</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnMoveMotor" class="w-full bg-yellow-500 text-white py-2 rounded-lg font-semibold hover:bg-yellow-600 text-sm hidden">Mover Marcador</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnRemovePlacement" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 text-sm hidden">Quitar UbicaciÃ³n</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </main>

Â  <script>
Â  Â  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzjJ17JRzCssUMC3K3vqdcF5oaixei64Md_1ThCaL3jLlaqubs-ge1FR3kQ8_I3oC8lbw/exec';
Â  Â  const PLANOS = { 'LINEA1': 'https://i.ibb.co/mFgffqxP/PLANO1.jpg', 'LINEA2': 'https://i.ibb.co/HTb9Vwph/PLANO2.jpg', 'LINEA3': 'https://i.ibb.co/ns0DSD90/PLANO3.jpg' };
Â  Â  const ESTADOS_CUMPLIMIENTO = ['SÃ­', 'No', 'En Mantenimiento', 'En Proceso', 'N/A'];
Â  Â Â 
Â  Â  let motores = [], motorSeleccionado = null, modoPosicionar = false, isMovingMarker = false;
Â  Â  let scale = 1, panX = 0, panY = 0, isPanning = false, startPanX, startPanY, clickStartX, clickStartY;

Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  document.getElementById('lineaSelector').addEventListener('change', cambiarLinea);
Â  Â  Â  Â  document.getElementById('btnCargarDatos').addEventListener('click', cargarDatos);
Â  Â  Â  Â  document.getElementById('btnGuardar').addEventListener('click', guardarCambiosMotor);
Â  Â  Â  Â  document.getElementById('motorSearch').addEventListener('input', filtrarListaMotores);
Â  Â  Â  Â  document.getElementById('btnPlaceMotor').addEventListener('click', activarModoColocar);
Â  Â  Â  Â  document.getElementById('btnMoveMotor').addEventListener('click', activarModoMover);
Â  Â  Â  Â  document.getElementById('btnRemovePlacement').addEventListener('click', quitarUbicacion);

Â  Â  Â  Â  const planoContainer = document.getElementById('planoContainer');
Â  Â  Â  Â  planoContainer.addEventListener('wheel', handleZoom, { passive: false });
Â  Â  Â  Â  planoContainer.addEventListener('mousedown', startPan);
Â  Â  Â  Â  planoContainer.addEventListener('mousemove', handlePan);
Â  Â  Â  Â  planoContainer.addEventListener('mouseup', endPan);
Â  Â  Â  Â  planoContainer.addEventListener('mouseleave', endPan);
Â  Â  Â  Â  planoContainer.addEventListener('click', manejarClicPlano, true);
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('zoomIn').addEventListener('click', () => handleZoom({ preventDefault:()=>{}, deltaY: -120, clientX: planoContainer.clientWidth/2, clientY: planoContainer.clientHeight/2 }));
Â  Â  Â  Â  document.getElementById('zoomOut').addEventListener('click', () => handleZoom({ preventDefault:()=>{}, deltaY: 120, clientX: planoContainer.clientWidth/2, clientY: planoContainer.clientHeight/2 }));
Â  Â  Â  Â  document.getElementById('zoomReset').addEventListener('click', resetZoom);
Â  Â  Â  Â Â 
Â  Â  Â  Â  cambiarLinea();
Â  Â  });

Â  Â  function applyTransform() { document.getElementById('transformWrapper').style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`; document.getElementById('zoomLevel').textContent = `${Math.round(scale * 100)}%`; }
Â  Â  function handleZoom(e) { e.preventDefault(); const oldScale = scale; const zoomFactor = 1.1; scale = e.deltaY < 0 ? scale * zoomFactor : scale / zoomFactor; scale = Math.max(0.2, Math.min(10, scale)); const rect = e.currentTarget.getBoundingClientRect(); const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top; panX = mouseX - (mouseX - panX) * (scale / oldScale); panY = mouseY - (mouseY - panY) * (scale / oldScale); applyTransform(); }
Â  Â  function startPan(e) { if (isMovingMarker || modoPosicionar) return; isPanning = true; startPanX = e.clientX - panX; startPanY = e.clientY - panY; clickStartX = e.clientX; clickStartY = e.clientY; }
Â  Â  function handlePan(e) { if (isPanning) { panX = e.clientX - startPanX; panY = e.clientY - startPanY; applyTransform(); } }
Â  Â  function endPan(e) { if (Math.abs(e.clientX - clickStartX) > 5 || Math.abs(e.clientY - clickStartY) > 5) { e.stopPropagation(); } isPanning = false; }
Â  Â  function resetZoom() { scale = 1; panX = 0; panY = 0; applyTransform(); }
Â  Â Â 
Â  Â  function cambiarLinea() { const linea = document.getElementById('lineaSelector').value; document.getElementById('lineaTitle').textContent = `LÃ­nea de ProducciÃ³n ${linea.slice(-1)}`; document.getElementById('planoImage').src = PLANOS[linea] || ''; resetZoom(); cargarDatos(); }
Â  Â Â 
Â  Â  async function llamarAppsScript(action, params = {}) { let url = `${APPS_SCRIPT_URL}?action=${action}&${new URLSearchParams(params)}`; return new Promise((resolve, reject) => { const cb = 'c' + Date.now(); window[cb] = d => { delete window[cb]; document.body.removeChild(s); d.success ? resolve(d) : reject(new Error(d.error || 'Error.')); }; const s = document.createElement('script'); s.src = `${url}&callback=${cb}`; s.onerror = () => reject(new Error('Error de red/CORS.')); document.body.appendChild(s); }); }
Â  Â  async function guardarDatosEnSheet(data) { try { await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) }); return { success: true }; } catch (error) { return { success: false, error: error.toString() }; } }
Â  Â  async function cargarDatos() {
Â  Â  Â  Â  actualizarEstado('Cargando...', 'info');
Â  Â  Â  Â  document.getElementById('fullMotorList').innerHTML = ''; document.getElementById('motorDetailsPanel').classList.add('hidden');
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const linea = document.getElementById('lineaSelector').value;
Â  Â  Â  Â  Â  Â  const data = await llamarAppsScript('list_motores', { linea });
Â  Â  Â  Â  Â  Â  motores = data.data.map(m => ({...m, PosX: parseFloat(m.PosX), PosY: parseFloat(m.PosY) }));
Â  Â  Â  Â  Â  Â  renderizarMotores(); renderizarListaCompleta(); actualizarEstadisticas();
Â  Â  Â  Â  Â  Â  actualizarEstado(`âœ… ${motores.length} motores cargados.`, 'success');
Â  Â  Â  Â  Â  Â  const badge = document.getElementById('connBadge');
Â  Â  Â  Â  Â  Â  badge.className = 'mt-3 flex items-center justify-center space-x-2 bg-green-600 px-3 py-1 rounded-full shadow text-white text-sm';
Â  Â  Â  Â  Â  Â  badge.querySelector('span').textContent = 'Conectado';
Â  Â  Â  Â  } catch (error) { actualizarEstado(`âŒ Error: ${error.message}`, 'error'); }
Â  Â  }

Â  Â  function renderizarMotores() {
Â  Â  Â  Â  const contenedor = document.getElementById('motoresContainer'); contenedor.innerHTML = '';
Â  Â  Â  Â  motores.filter(m => !isNaN(m.PosX) && !isNaN(m.PosY)).forEach(motor => {
Â  Â  Â  Â  Â  Â  const marcador = document.createElement('div'); marcador.className = 'motor-marker';
Â  Â  Â  Â  Â  Â  if (motor.Cumplimiento === 'SÃ­') marcador.classList.add('completed');
Â  Â  Â  Â  Â  Â  else if (motor.Cumplimiento === 'En Mantenimiento') marcador.classList.add('maintenance');
Â  Â  Â  Â  Â  Â  else marcador.classList.add('pending');
Â  Â  Â  Â  Â  Â  marcador.style.left = `${motor.PosX}%`; marcador.style.top = `${motor.PosY}%`;
Â  Â  Â  Â  Â  Â  marcador.textContent = motor.ID.replace(/\D/g, ''); marcador.title = `${motor.ID}: ${motor.NombreZona}`;
Â  Â  Â  Â  Â  Â  marcador.dataset.id = motor.ID; marcador.style.pointerEvents = 'auto';
Â  Â  Â  Â  Â  Â  marcador.addEventListener('click', e => { e.stopPropagation(); seleccionarMotor(marcador.dataset.id, true); });
Â  Â  Â  Â  Â  Â  contenedor.appendChild(marcador);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function renderizarListaCompleta() { const c = document.getElementById('fullMotorList'); c.innerHTML = ''; motores.forEach(m => { const p = !isNaN(m.PosX) && !isNaN(m.PosY); const i = document.createElement('div'); i.className = 'motor-list-item flex items-center justify-between p-2 rounded-md'; i.dataset.motorId = m.ID; i.innerHTML = `<div class="text-sm"><span class="font-bold">${m.ID}</span><span class="text-slate-600 truncate ml-2">${m.NombreZona || 'Sin zona'}</span></div><span class="${p ? 'text-green-500' : 'text-slate-400'}">${p ? 'âœ”' : 'âœ–'}</span>`; i.addEventListener('click', () => seleccionarMotor(m.ID, true)); c.appendChild(i); }); }
Â  Â  function actualizarEstadisticas() { const s = motores.reduce((a, m) => { let st = (m.Cumplimiento || '').toString().trim() || 'No'; a[st] = (a[st] || 0) + 1; return a; }, {}); document.getElementById('statsContainer').innerHTML = `<div class="flex justify-between items-center"><span class="font-semibold">Total:</span> <span class="font-bold text-lg">${motores.length}</span></div><hr class="my-2"><div class="flex justify-between items-center"><span class="text-green-600 font-semibold">â— Cumplen:</span> <span class="font-bold">${s['SÃ­'] || 0}</span></div><div class="flex justify-between items-center"><span class="text-red-600 font-semibold">â— Pendientes:</span> <span class="font-bold">${s['No'] || 0}</span></div><div class="flex justify-between items-center"><span class="text-yellow-500 font-semibold">â— Mantenimiento:</span> <span class="font-bold">${s['En Mantenimiento'] || 0}</span></div><div class="flex justify-between items-center"><span class="text-blue-600 font-semibold">â— En Proceso:</span> <span class="font-bold">${s['En Proceso'] || 0}</span></div><div class="flex justify-between items-center"><span class="text-gray-500 font-semibold">â— N/A:</span> <span class="font-bold">${s['N/A'] || 0}</span></div>`; }
Â  Â  function filtrarListaMotores(e) { const f = e.target.value.toLowerCase(); document.querySelectorAll('.motor-list-item').forEach(i => { i.style.display = i.textContent.toLowerCase().includes(f) ? 'flex' : 'none'; }); }

Â  Â  function seleccionarMotor(motorId, scrollPanel = false) {
Â  Â  Â  Â  motorSeleccionado = motores.find(m => m.ID === motorId); if (!motorSeleccionado) return;
Â  Â  Â  Â  document.querySelectorAll('.motor-marker, .motor-list-item').forEach(m => m.classList.remove('selected'));
Â  Â  Â  Â  document.querySelector(`.motor-marker[data-id="${motorId}"]`)?.classList.add('selected');
Â  Â  Â  Â  document.querySelector(`.motor-list-item[data-motor-id="${motorId}"]`)?.classList.add('selected');
Â  Â  Â  Â  const panel = document.getElementById('motorDetailsPanel'); panel.classList.remove('hidden');Â 
Â  Â  Â  Â  if (scrollPanel) { panel.scrollIntoView({ behavior: 'smooth', block: 'end' }); }
Â  Â  Â  Â  panel.querySelector('#motorIdTitle').textContent = motorSeleccionado.ID; panel.querySelector('#motorNombreZona').value = motorSeleccionado.NombreZona || '';
Â  Â  Â  Â  panel.querySelector('#motorEstado').innerHTML = ESTADOS_CUMPLIMIENTO.map(e => `<option value="${e}" ${e === (motorSeleccionado.Cumplimiento || 'No') ? 'selected' : ''}>${e}</option>`).join('');
Â  Â  Â  Â  panel.querySelector('#motorObservaciones').value = motorSeleccionado.Observaciones || '';
Â  Â  Â  Â  let imgUrl = motorSeleccionado.ImagenURL || ''; if (imgUrl.includes('drive.google.com')) { const fileId = (imgUrl.match(/d\/(.+?)\//) || [])[1]; imgUrl = fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : ''; } panel.querySelector('#motorImage').src = imgUrl || 'https://via.placeholder.com/300x100?text=Sin+Imagen';
Â  Â  Â  Â  const isPlaced = !isNaN(motorSeleccionado.PosX) && !isNaN(motorSeleccionado.PosY);
Â  Â  Â  Â  document.getElementById('btnPlaceMotor').classList.toggle('hidden', isPlaced);
Â  Â  Â  Â  document.getElementById('btnMoveMotor').classList.toggle('hidden', !isPlaced);
Â  Â  Â  Â  document.getElementById('btnRemovePlacement').classList.toggle('hidden', !isPlaced);
Â  Â  }

Â  Â  function activarModoMover() { if (!motorSeleccionado) return; isMovingMarker = true; document.getElementById('planoContainer').classList.add('moving-mode'); actualizarEstado(`MODO MOVER: Haga clic en la nueva ubicaciÃ³n para ${motorSeleccionado.ID}.`, 'info'); }
Â  Â  function activarModoColocar() { if (!motorSeleccionado) return; modoPosicionar = true; document.getElementById('planoContainer').classList.add('placing-mode'); actualizarEstado(`MODO COLOCAR: Haga clic en la ubicaciÃ³n para ${motorSeleccionado.ID}.`, 'info'); }
Â  Â  async function quitarUbicacion() { if (!motorSeleccionado || !confirm(`Â¿Quitar la ubicaciÃ³n del motor ${motorSeleccionado.ID}?`)) return; actualizarEstado(`Quitando ubicaciÃ³n de ${motorSeleccionado.ID}...`, 'info'); await guardarDatosEnSheet({ action: 'update_motor', linea: document.getElementById('lineaSelector').value, motorId: motorSeleccionado.ID, data: { PosX: '', PosY: '' } }); await cargarDatos(); actualizarEstado(`âœ… UbicaciÃ³n eliminada.`, 'success'); }
Â  Â Â 
Â  Â  async function manejarClicPlano(e) {
Â  Â  Â  Â  if (!modoPosicionar && !isMovingMarker) return;
Â  Â  Â  Â  const container = document.getElementById('planoContainer'); const rect = container.getBoundingClientRect();
Â  Â  Â  Â  const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top;
Â  Â  Â  Â  const x_on_image = (mouseX - panX) / scale; const y_on_image = (mouseY - panY) / scale;
Â  Â  Â  Â  const x_perc = (x_on_image / container.clientWidth) * 100;
Â  Â  Â  Â  const y_perc = (y_on_image / container.clientHeight) * 100;

Â  Â  Â  Â  if (x_perc < 0 || x_perc > 100 || y_perc < 0 || y_perc > 100) { alert("PosiciÃ³n fuera del plano."); return; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const motorId = motorSeleccionado.ID;
Â  Â  Â  Â  actualizarEstado(`Guardando ubicaciÃ³n para ${motorId}...`, 'info');
Â  Â  Â  Â  await guardarDatosEnSheet({ action: 'update_motor', linea: document.getElementById('lineaSelector').value, motorId: motorId, data: { PosX: x_perc.toFixed(2), PosY: y_perc.toFixed(2) } });
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (isMovingMarker) { isMovingMarker = false; document.getElementById('planoContainer').classList.remove('moving-mode'); }
Â  Â  Â  Â  if (modoPosicionar) { modoPosicionar = false; document.getElementById('planoContainer').classList.remove('placing-mode'); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  await cargarDatos(); seleccionarMotor(motorId, true);
Â  Â  Â  Â  actualizarEstado(`âœ… UbicaciÃ³n guardada.`, 'success');
Â  Â  }

Â  Â  async function guardarCambiosMotor() {
Â  Â  Â  Â  if (!motorSeleccionado) return;
Â  Â  Â  Â  actualizarEstado(`Guardando cambios para ${motorSeleccionado.ID}...`, 'info');
Â  Â  Â  Â  const newData = { Cumplimiento: document.getElementById('motorEstado').value, Observaciones: document.getElementById('motorObservaciones').value };
Â  Â  Â  Â  await guardarDatosEnSheet({ action: 'update_motor', linea: document.getElementById('lineaSelector').value, motorId: motorSeleccionado.ID, data: newData });
Â  Â  Â  Â  Object.assign(motorSeleccionado, newData);
Â  Â  Â  Â  renderizarMotores(); renderizarListaCompleta(); actualizarEstadisticas();
Â  Â  Â  Â  seleccionarMotor(motorSeleccionado.ID, false);
Â  Â  Â  Â  actualizarEstado(`âœ… Cambios guardados.`, 'success');
Â  Â  }
Â  Â Â 
Â  Â  function actualizarEstado(mensaje, tipo) { const el = document.getElementById('statusMsg'); el.textContent = mensaje; el.className = 'text-sm text-center font-semibold '; if (tipo === 'success') el.classList.add('text-green-600'); else if (tipo === 'error') el.classList.add('text-red-600'); else el.classList.add('text-blue-600'); }
Â  </script>
</body>
</html>
